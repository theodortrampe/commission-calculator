// schema.prisma

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
}

// --------------------------------------
// 0. ORGANIZATION (Multi-Tenant)
// --------------------------------------

model Organization {
  id        String   @id @default("default-org-001")
  name      String   @default("My First Client")
  slug      String   @unique @default("client-slug")

  // Relations
  users       User[]
  compPlans   CompPlan[]
  orders      Order[]
  payouts     Payout[]
  adjustments Adjustment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("organizations")
}

// --------------------------------------
// 1. USERS
// --------------------------------------

enum Role {
  ADMIN
  REP
  MANAGER
}

model User {
  id            String    @id @default(uuid())
  email         String
  name          String
  role          Role      @default(REP)
  
  // Auth fields
  passwordHash  String?   // null for OAuth-only users
  emailVerified DateTime?
  image         String?
  
  // Compensation currency (EUR or USD)
  currency      String    @default("USD")
  
  // Status (for offboarding without hard-deleting)
  isActive      Boolean   @default(true)
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Hierarchy
  managerId String?
  manager   User?    @relation("ManagerToRep", fields: [managerId], references: [id])
  reports   User[]   @relation("ManagerToRep")

  // Data
  periodData  UserPeriodData[]
  orders      Order[]
  payouts     Payout[]
  adjustments Adjustment[]
  planAssignments PlanAssignment[]
  
  // Auth.js relations
  accounts    Account[]
  sessions    Session[]

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@unique([email, organizationId])
  @@map("users")
}

// Auth.js Account model (for OAuth providers)
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// Auth.js Session model
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// --------------------------------------
// 2. PERIOD DATA (The "Rate Source")
// --------------------------------------

model UserPeriodData {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // The "When"
  month       DateTime // 2023-10-01
  
  // The "Input Variables" (Synced from BigQuery)
  title       String?
  quota       Float    // Denominator
  baseSalary  Float    // Subtractor
  ote         Float    // Minuend
  
  // The "Output Variable" (Derived)
  // We store this to prevent historical changes if math logic changes later
  effectiveRate Float  // (OTE - Base) / Quota

  // Relations
  planId        String?
  plan          CompPlan? @relation(fields: [planId], references: [id])

  @@unique([userId, month])
  @@map("user_period_data")
}

// --------------------------------------
// 3. ORDERS
// --------------------------------------

model Order {
  id             String      @id @default(uuid())
  orderNumber    String      @unique 
  
  // Financials
  convertedUsd   Float
  convertedEur   Float
  
  bookingDate    DateTime    

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relations
  userId         String
  user           User        @relation(fields: [userId], references: [id])
  
  @@index([organizationId])
  @@map("orders")
}

// --------------------------------------
// 4. LOGIC CONFIG (Accelerators Only)
// --------------------------------------

enum PayoutFreq {
  MONTHLY
  QUARTERLY
}

model CompPlan {
  id          String     @id @default(uuid())
  name        String     // "AE 2024 Accelerator Plan"
  frequency   PayoutFreq
  description String?    // "Core AE plan with standard accelerators"

  // Logic fields
  baseRateMultiplier Float   @default(1.0)
  quota              Float   @default(0.0)
  acceleratorsEnabled Boolean @default(true)
  kickersEnabled      Boolean @default(false)
  accelerators Json?
  kickers      Json?

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relations
  assignments PlanAssignment[]
  steps       RampStep[]
  periodData  UserPeriodData[]

  @@index([organizationId])
  @@map("comp_plans")
}

model RampStep {
  id        String   @id @default(uuid())
  planId    String
  plan      CompPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  monthIndex     Int      // 1, 2, 3...
  quotaPercentage Float   // 0.5 = 50%
  guaranteedDrawPercent Float? // % of variable bonus (e.g. 75 = 75%)
  drawType       DrawType @default(NON_RECOVERABLE)
  
  disableAccelerators Boolean @default(true)
  disableKickers      Boolean @default(true)

  @@unique([planId, monthIndex])
  @@map("ramp_steps")
}

enum DrawType {
  NON_RECOVERABLE
  RECOVERABLE
}

model PlanAssignment {
  id        String   @id @default(uuid())
  
  // Who?
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  role      Role?    // Optional: Assign to all REPs
  
  // Which Plan?
  planId    String
  plan      CompPlan @relation(fields: [planId], references: [id])
  
  // When?
  startDate DateTime
  endDate   DateTime? // null = forever

  createdAt DateTime @default(now())

  @@map("plan_assignments")
}

// --------------------------------------
// 5. PAYOUTS (Historical Record)
// --------------------------------------
// *Real-time views do NOT query this table. They query Orders + PeriodData directly.*

enum AdjustmentType {
  REVENUE       // Additional bookings $ that flows through commission calculation
  FIXED_BONUS   // Fixed $ bonus added directly to final payout
}

enum PayoutStatus {
  DRAFT
  PUBLISHED
}

model Payout {
  id             String       @id @default(uuid())
  periodStart    DateTime     
  periodEnd      DateTime
  
  grossEarnings  Float        
  finalPayout    Float        
  
  status         PayoutStatus @default(DRAFT)

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  userId         String
  user           User         @relation(fields: [userId], references: [id])
  adjustments    Adjustment[] 
  
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@map("payouts")
}

model Adjustment {
  id             String         @id @default(uuid())
  amount         Float    
  reason         String   
  adjustmentType AdjustmentType @default(FIXED_BONUS)
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Link to user and period (allows adjustments before payout exists)
  userId         String
  user           User           @relation(fields: [userId], references: [id])
  month          DateTime
  
  // Optional link to payout (connected when payout is generated)
  payoutId       String?
  payout         Payout?        @relation(fields: [payoutId], references: [id])
  
  createdAt      DateTime       @default(now())

  @@index([organizationId])
  @@map("adjustments")
}
